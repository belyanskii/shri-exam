<!DOCTYPE html>
<html>
<head>
    <title>Gallery</title>
    <link rel="stylesheet" href="css/style.css"/>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/jquery.mousewheel.js"></script>
</head>
<body class="b-page">
    <div class="b-slider__wrap">
        <ul class="b-slider"></ul>
    </div>
    <i class="b-nav b-nav-prev" onclick="changeImg('prev')"></i>
    <i class="b-nav b-nav-next" onclick="changeImg('next')"></i>
    <div class="b-thumbs__bg">
        <div class="b-thumbs__wrap">
            <ul class="b-thumbs"></ul>
        </div>
    </div>
    <script type="text/javascript">
        var jsonData,
            imagesData,
            dWidth = $(document).width(),
            slider = $('.b-slider');

        function getData(){
            var apiUrl = 'http://api-fotki.yandex.ru/api/users/aig1001/album/63684/photos/created/?format=json&callback=?';
            $.getJSON(apiUrl, function(data) {
                jsonData = data;
                imagesData = jsonData.entries;
                takeFirstImage();
                imagesPreload(0, 20);
                $('.b-thumbs__item').first().addClass('b-thumbs__item-cur');
            });
        }

        var image = function(src, alt, cls){
            return $('<img />', {
                'alt':alt,
                'src': src,
                'class': cls
            });
        }

        function createThumb(i){
            var thumbImgLink = imagesData[i].img.XXS.href,
                    thumbImgTitle= imagesData[i].title,
                    bigImage = imagesData[i].img.L.href,
                    thumbsWrap = $('.b-thumbs'),
                    thumbsItem = $('<li class="b-thumbs__item"/>'),
                    thumbsItemPrev = $('.b-thumbs__item').last(),
                    thumbsImg = image(thumbImgLink, thumbImgTitle, 'b-thumbs__img');

            thumbsItem.append(thumbsImg).appendTo(thumbsWrap).data("curInfo", { number: i, curImgSrc: bigImage });
            if(thumbsItemPrev.length > 0){
                thumbsItemPrev.data("nextInfo", { nextImgSrc: bigImage });
            }
        }

        function imagesPreload(from, to){
            for (var i=from;i<to;i++)
            {
                if(imagesData[i]){
                    createThumb(i);
                }
            }
        }

        function takeFirstImage(){
            var firstImgLink = imagesData[0].img.L.href,
                    firstImgAlt = imagesData[1].title,
                    sliderItem = $('<li class="b-slider__item" />');

            $('<li class="b-slider__item" style="width:'+dWidth+'px;"><img class="b-slider__item-img" src="'+firstImgLink+'"/></li>').appendTo(slider);
        }

        function changeImg(direction, thumb){
            direction = direction || 'thumb';
            thumb = thumb || 'thumb';
            var curThumb = $('.b-thumbs__item-cur');

            if(direction === 'next' && curThumb.is(':not(:last-child)') != 0 && slider.position().left === 0){

                var nextImgLink = curThumb.data('nextInfo').nextImgSrc;

                curThumb.removeClass('b-thumbs__item-cur').next().addClass('b-thumbs__item-cur');

                slider.append($('<li class="b-slider__item" style="width:'+dWidth+'px;"><img class="b-slider__item-img" src="'+nextImgLink+'"/></li>')).animate({left:"-="+dWidth+"px"}, 500, function() {
                    slider.css('left', 0).children().first().remove();
                });

            }else if(direction === 'prev' && curThumb.is(':not(:first-child)') != 0 && slider.position().left === 0){

                var prevImgLink = curThumb.prev().data('curInfo').curImgSrc;

                curThumb.removeClass('b-thumbs__item-cur').prev().addClass('b-thumbs__item-cur');

                slider.css('left', -dWidth).prepend('<li class="b-slider__item" style="width:'+dWidth+'px;"><img class="b-slider__item-img" src="'+prevImgLink+'"/></li>').animate({left:"+="+dWidth+"px"}, 500, function(){
                    slider.css('left', 0).children().last().remove();
                });
            }else if(direction === 'thumb' && slider.position().left === 0 && !thumb.hasClass('b-thumbs__item-cur')){
                var imgSrc = thumb.data('curInfo').curImgSrc,
                    curThumbNumber = curThumb.index(),
                    thumbNumber = thumb.index();

                thumb.addClass('b-thumbs__item-cur').siblings().removeClass('b-thumbs__item-cur');

                if(thumbNumber < curThumbNumber){
                    slider.css('left', -dWidth).prepend('<li class="b-slider__item" style="width:'+dWidth+'px;"><img class="b-slider__item-img" src="'+imgSrc+'"/></li>').animate({left:"+="+dWidth+"px"}, 500, function(){
                        slider.css('left', 0).children().last().remove();
                    });
                }else{
                    slider.append('<li class="b-slider__item" style="width:'+dWidth+'px;"><img class="b-slider__item-img" src="'+imgSrc+'"/></li>').animate({left:"-="+dWidth+"px"}, 500, function(){
                        slider.css('left', 0).children().first().remove();
                    });
                }
            }

        }

        function recalcWidth(){
            dWidth = $(document).width();
            $('.b-slider__item').css('width', dWidth);
        }

        $(window).load(function(){
            getData();
            recalcWidth();
        });

        $(window).resize(function(){
            recalcWidth();
        });

        $(function(){
            $('body').on('click', '.b-thumbs__item', function(){
                changeImg('thumb', $(this));
            });

            $(".b-thumbs").mousewheel(function(event, delta) {

                $(this).css({left:"-="+(delta * 30)+"px"});

                event.preventDefault();

            });
        });
    </script>
</body>
</html>